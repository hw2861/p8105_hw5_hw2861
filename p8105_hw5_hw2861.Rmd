---
title: "p8105_hw5_hw2861"
author: "Hongmiao Wang"
date: "2022-11-12"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE)
```

## Problem 2
### Describe the raw data
```{r homicides_raw}
homicide_raw_df = 
  read_csv("./Data/homicide-data.csv")
```

This raw dataset has `r nrow(homicide_raw_df)` observations and `r ncol(homicide_raw_df)` variables. It collected data on `r nrow(homicide_raw_df)` criminal homicides over the past decade in 50 of the largest American cities. The data included the location of the killing, whether an arrest was made and, in most cases, basic demographic information about each victim.

```{r homicides}
homicide_df = 
  read_csv("./Data/homicide-data.csv") %>% 
  mutate(
    city_state = str_c(city, state, sep = ","),
    city_state = recode(city_state,"Tulsa,AL" = "Tulsa,OK"),
    status = case_when(
      disposition == "Closed without arrest" | disposition == "Open/No arrest"   ~ "unsolved",
      TRUE ~ "solved"))
```

### Summarize within cities: to obtain the total number of homicides and the number of unsolved homicides

**The total number of homicides and the number of unsolved homicides in each cities.** 
```{r summary1}
homicides_df_number= 
  homicide_df %>%
  select(city_state,status)%>%
  group_by(city_state)%>%
  summarize(
    total_homicides=n(),
    unsolved_homicides=sum(status=="unsolved")) 

    knitr::kable(homicides_df_number)
```

**The total number of homicides and the number of unsolved homicides in (e.g. “Baltimore, MD”)  cities.** 
```{r summary_baltimore}
homicides_baltimore= 
  homicide_df %>%
  select(city_state,status)%>%
  filter(city_state == "Baltimore,MD") %>%
  group_by(city_state)%>%
  summarize(
    total_homicides=n(),
    unsolved_homicides=sum(status=="unsolved")) 

    knitr::kable(homicides_baltimore)
```

**The total number of homicides in “Baltimore, MD” is 2827 and the number of unsolved homicides in “Baltimore, MD” is 1825.**

### For the city of Baltimore, MD, use the prop.test function to estimate the proportion of homicides that are unsolved
```{r homicides_md_test}
Baltimore_prop=prop.test(
  x= homicides_df_number %>% filter(city_state == "Baltimore,MD")%>% pull(unsolved_homicides), 
  n= homicides_df_number %>% filter(city_state == "Baltimore,MD")%>% pull(total_homicides)
  ) %>% 
  broom::tidy()%>% 
  select(estimate,conf.low,conf.high)

Baltimore_prop
```
**The proportion of homicides that are unsolved in “Baltimore, MD”  is `r Baltimore_prop$estimate` . 
The 95CI of the proportion is between `r Baltimore_prop$conf.low` and  `r Baltimore_prop$conf.high`.**

### Now run prop.test for each of the cities in my dataset.

**First, Create a function for prop.test**
```{r prop_function}
prop_function = function(city) {
  
 test= prop.test(
     x= pull(city,unsolved_homicides), 
     n= pull(city,total_homicides) )%>%
    broom::tidy() %>%
    select(estimate, conf.low,conf.high)
 
 return(test)
}
```

**Run the function for each of the cities**
```{r city_prop}
city_prop_df =
  homicides_df_number %>%
  nest(data = total_homicides:unsolved_homicides) %>% 
  mutate(result = map(data,prop_function)) %>% 
  select(city_state, result)%>% 
  unnest(result)
```


### Create a plot that shows the estimates and 95CIs for each city
```{r city_prop_plot}
city_prop_df %>% 
  mutate(city_state = fct_reorder(city_state, estimate)) %>% 
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point() + 
  labs(
    x = "City,State",
    y = "The proportion of homicides unsolved")+
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) + 
  theme(axis.text.x = element_text(angle = 80, hjust = 1))
```

## Problem 3